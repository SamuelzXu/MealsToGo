<!DOCTYPE html>
<html lang="en" ng-app>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>Pocketask - Delivery at a click</title>
    <meta name="author" content="Pocketask Inc.">
    <meta name="description" content="Pocketask is now in Waterloo & Kitchener region. With Pocketask, restaurants can secure a delivery driver in 10 minutes or less. Pocketask streamlines the food delivery process; restaurant owners can request a driver, and pre-screened drivers can accept the call.">
    <meta name="keywords" content="pocketask, food delivery, restaurant, catering, local, waterloo, kitchener, takeout" >

    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1">
    <meta name="HandheldFriendly" content="True">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="shortcut icon" href="../img/favicon.ico">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/trunk.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.css">
    <link rel="stylesheet" href="../css/bootstrap-switch.min.css">
</head>

<body>
    <header class="slide">
        <ul id="navToggle" class="burger slide">
            <li></li><li></li><li></li>
        </ul>
        <h1 class="hidden-xs"><img class="brand-img" id="brand-lg" src="../img/kraken-uzyqfr/logo-big.png" style="height: 48px; margin-bottom: -8px;"></h1>
        <h1 class="visible-xs"><img class="brand-img" id="brand-xs" src="../img/kraken-uzyqfr/logo-small.png"></h1>
    </header>

    <nav class="slide nav" id="nav-menu">
        <ul>
            <li><a href="/">LOG OUT</a></li>
        </ul>
    </nav>

    <div class="content slide">
        <!-- <div class="visible-xs visible-sm" style="height: 40px;"></div> -->
        <div class="wrapper" style="min-height: 600px; padding-top: 70px; height: 100%;" ng-controller="driverctrl">
            <div class="col-md-3">
                <div class="pad">
                    <div class="card">
                        <p class="card-heading">Please change your status here</p>
                        <br>
                        <br>
                        <input type="checkbox" name="my-checkbox" checked id="switch" data-on-text="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AVAILABLE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" data-off-text="UNAVAILABLE" data-size="large">
                        <br>
                        <div class="error-box" id="user-fail-box">
                            <p>Something wrong with change status, please try again.</p>
                        </div>
                    </div>
                    <div class="card">
                        <p class="card-heading">Personal Information</p>
                        <p id="name">name</p>
                        <p id="address">address</p>
                        <p id="phone">phone</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6" style="background-color: #eeeeee;">
                <div class="pad" ng-controller="driverhistctrl">
                    <div class="card-long" id="history-card" style="overflow-y: auto; height: 530px;">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <td style="font-family: Impact; color: #777;">Time</td>
                                    <td style="font-family: Impact; color: #777;">Requested By</td>
                                    <td style="font-family: Impact; color: #777;">
                                    Destination</td>
                                    <td style="font-family: Impact; color: #777;">Distance</td>
                                    <td style="font-family: Impact; color: #777;">Status</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr ng-repeat="dhist in dhists">
                                    <td>{{dhist.requestedAt}}</td>
                                    <td>{{dhist.requestedBy.fullname}}</td>
                                    <td>{{dhist.destination}}</td>
                                    <td>{{dhist.distance}}</td>
                                    <td>{{dhist.status}}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-3" style="background-color: #eeeeee;">
                <div class="pad">
                    <div class="card">
                        <p class="card-heading">Change Password</p>
                        <div id="message-box" class="result-box">
                            <p></p>
                        </div>
                        <div id="success-box" class="success-box">
                            <p></p>
                        </div>
                        <form method="post" name="form">
                            <input class="form-control" id="old" name="old" 
                             placeholder="Old password" type="password" parsley-required="true" />
                            <input class="form-control" id="new" name="new" 
                             placeholder="New password" type="password" parsley-required="true" />
                            <div id="inlineKeypad"></div>
                            <input id="signin-button" type="button" onclick="change()" value="Make change" />
                        </form> 
                    </div>
                    <div class="card" id="user-profile-function">
                        <p class="card-heading">Gadgets</p>
                        <a href="../restimg" target="_blank">&bull; View Restaurants' Image</a>
                    </div>
                </div>
            </div>
        </div>
        <div id="footer" style="display : none;">
            <div class="col-md-4 footer-text">
                <p><a href="/privacypolicy" style="padding-right: 20px" target="_blank">Privacy Policy</a> <a href="/termofuse" target="_blank">Term of Use</a></p>
            </div>
            <div class="col-md-4 footer-text">
                <p>&#169; 2014 Pocketask Inc. All Rights Reserved.</p>
            </div>
            <div class="col-md-4 footer-social">
                <a id="facebook-icon" href="https://www.facebook.com/pocketask" target="_blank"><i class="fa fa-facebook-square fa-3x"></i></a>
                <a id="twitter-icon" href="https://twitter.com/Pocketask" target="_blank"><i class="fa fa-twitter-square fa-3x"></i></a>
                <a id="google-plus-icon" href="https://plus.google.com/b/104407058385138355470/" target="_blank"><i class="fa fa-google-plus-square fa-3x"></i></a>
                <a id="linkedin-icon" href="http://www.linkedin.com/company/pocketask-inc?trk=company_name" target="_blank"><i class="fa fa-linkedin-square fa-3x"></i></a>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script type="text/javascript" src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script src="../js/trunk.js"></script>
    <script src="../js/bootstrap-switch.min.js"></script>
    <script src="/js/angular.min.js"></script>

    <script>
    function getDriver(){
        var result = null;
        $.ajax({
            type : "GET",
            dataType : 'json',
            async : false,
            url : "https://pocketask-api.herokuapp.com/drivers/get",
            headers : {
                token : localStorage.getItem("token")
            },
            success : function(data) {
                result = data;
            }
        });
        return result;
    }
    var driver = getDriver();
    function driverctrl() {
        document.getElementById("name").innerHTML = "Name: " + driver.fullname;
        document.getElementById("phone").innerHTML = "Phone: " + driver.phone;
        document.getElementById("address").innerHTML = "Address: " + driver.address.full;
    }
    function getDriverHistory(){
        var result = null;
        $.ajax({
            type : "GET",
            dataType : 'json',
            async : false,
            url : "https://pocketask-api.herokuapp.com/requests/driver_history",
            headers : {
                token : localStorage.getItem("token")
            },
            success : function(data) {
                result = data;
            }
        });
        return result;
    }
    var dhist = getDriverHistory();
    function driverhistctrl($scope){
        $scope.dhists = [];
        angular.forEach(dhist, function(value) {
            value.requestedAt = new Date(value.requestedAt).toString().substring(0, 25);
            // if (value.status === 9) {
            //     value.status = "Completed";
            // } else {
            //     value.status = "Ongoing";
            // }
            if (value.status === 9) {
                value.status = 'Accepted';
            } else if (value.status === 10) {
                value.status = 'Picked Up';
            } else if (value.status === 5) {
                value.status = 'Pending';
            } else if (value.status === 255) {
                value.status = 'Completed';
            } else {
                value.status = 'Error';
            }
            $scope.dhists.push(value);
        });
    }
    function change(){
        var oldPassword = form.old.value;
        var newPassword = form.new.value;
        $.ajax({
            type : "PUT",
            url : "https://pocketask-api.herokuapp.com/users/password",
            data : {password:oldPassword, newpassword:newPassword},
            dataType: 'json',
            headers : {
                token : localStorage.getItem("token")
            },
            statusCode: {
                400: function(res) {
                    document.getElementById("message-box").style.display = 'block';
                    document.getElementById("message-box").innerHTML = 'Your password is wrong, please try again.';
                    setTimeout(function() {
                        document.getElementById("message-box").style.display = 'none';
                    }, 5000);
                },
                200: function(res) {
                    document.getElementById("success-box").style.display = 'block';
                    document.getElementById("success-box").innerHTML = res.msg;
                    setTimeout(function() {
                        document.getElementById("success-box").style.display = 'none';
                    }, 5000);
                    document.getElementById("old").value = "";
                    document.getElementById("new").value = "";
                }
            }
        });
    }
    </script>
    <script>
    $("#switch").bootstrapSwitch('state', driver.available);
    var avail = driver.available;
    $("#switch").on('switchChange.bootstrapSwitch', function(event, state) {
        var available;
        if (avail === true) {
            avail = false;
        } else if (avail === false) {
            avail = true;
        }
        $.ajax({
            type : "GET",
            dataType : 'json',
            async : false,
            url : "https://pocketask-api.herokuapp.com/drivers/set_availability",
            data : {available : avail},
            headers : {
                token : localStorage.getItem("token")
            },
            statusCode: {
                404 : function(){
                    document.getElementById("error-box").style.display = 'block';
                    setTimeout(function(){document.getElementById("user-fail-box").style.display = 'none';}, 5000);
                },
                500 : function(){
                    document.getElementById("error-box").style.display = 'block';
                    setTimeout(function(){document.getElementById("user-fail-box").style.display = 'none';}, 5000);
                }
            }
        })    
    });
    </script>
</body>
</html>